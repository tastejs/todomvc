/**
 * abaaso.datalist
 *
 * @author Jason Mulligan <jason.mulligan@avoidwork.com>
 * @copyright Jason Mulligan 2012
 * @license BSD-3 <http://opensource.org/licenses/BSD-3-Clause>
 * @link https://github.com/avoidwork/abaaso.datalist
 * @module abaaso.datalist
 * @version 1.1.9
 */
(function(a){"use strict";var b,c=/top|bottom/,d=function(a,c,d,e){var h=[c],i=this,j,k;if(a instanceof Element&&typeof c=="object"&&!!/string|object/.test(typeof d))return j=a.create("ul",{"class":"list",id:c.parentNode.id+"-datalist"}),this.element=j,this.callback=null,this.filter=null,this.pageIndex=1,this.pageSize=null,this.pageRange=5,this.pagination="bottom",this.placeholder="",this.order="",this.ready=!1,this.refreshing=!1,this.template=d,this.total=0,this.sensitivity="ci",this.store=h[0],e instanceof Object&&b.iterate(e,function(a,b){i[b]=a}),this.store.parentNode.on("afterDataDelete",function(a){this.element.fire("beforeDataListRefresh");if(f(this.store.parentNode,j.id,"afterDataDelete","delete-"+j.id))return;typeof this.pageIndex=="number"&&typeof this.pageSize=="number"?this.refresh():this.element.find("> li[data-key='"+a.key+"']").destroy(),this.element.fire("afterDataListRefresh")},"delete-"+j.id,this),k=function(){var a=this.store.retrieve?"afterDataRetrieve":"afterDataSync";this.store.parentNode.once(a,function(){if(f(this.store.parentNode,j.id,a,"refresh-"+j.id))return;!this.refreshing&&(a==="afterDataRetrieve"||this.store.loaded)&&this.refresh(),k.call(this)},"refresh-"+j.id,this),g.call(this)&&this.refresh()},g.call(this)?k.call(this):this.store.parentNode.once(this.store.parentNode.retrieve?"afterDataRetrieve":"afterDataSync",k,"initialize-"+j.id,this),this;throw Error(b.label.error.invalidArguments)};d.prototype.page=function(a){if(isNaN(a))throw Error(b.label.error.invalidArguments);return this.pageIndex=a,this.refresh(),this},d.prototype.pages=function(){var a=this.element,d=b("#"+a.id+"-pages-top, #"+a.id+"-pages-bottom"),e=this.pageIndex,f=this.pagination,g=this.pageRange,i=g.half().roundDown(),j=e-i,k=e+i,l=this,m=h.call(this),n=0,o,p,q;if(!c.test(f))throw Error(b.label.error.invalidArguments);return d.each(function(a){typeof a!="undefined"&&a.destroy()}),this.total===0||m===1?this:(j<1&&(o=j.diff(1),j=j+o,k=k+o),k>m&&(k=m,j=k-g+1,j<1&&(j=1)),f.explode().each(function(b){d=a[b==="bottom"?"after":"before"]("ul",{"class":"list pages "+b,id:a.id+"-pages-"+b}),e>1?d.create("li").create("a",{"class":"first page","data-page":1}).html("&lt;&lt;").on("click",function(){l.page(this.data("page"))},"click"):d.create("li").create("span",{"class":"first page"}).html("&lt;&lt;"),e>1?d.create("li").create("a",{"class":"prev page","data-page":e-1}).html("&lt;").on("click",function(){l.page(this.data("page"))},"click"):d.create("li").create("span",{"class":"prev page"}).html("&lt;");for(b=j;b<=k;b++)b!==e?d.create("li").create("a",{"class":b===e?"current page":"page","data-page":b}).html(b).on("click",function(a){l.page(this.data("page"))},"click"):d.create("li").create("span",{"class":"page"}).html(b);e+1<=m?d.create("li").create("a",{"class":"next page","data-page":e+1}).html("&gt;").on("click",function(){l.page(this.data("page"))},"click"):d.create("li").create("span",{"class":"next page"}).html("&gt;"),e<m?d.create("li").create("a",{"class":"last page","data-page":m}).html("&gt;&gt;").on("click",function(){l.page(this.data("page"))},"click"):d.create("li").create("span",{"class":"last page"}).html("&gt;&gt;"),d.find("a").on("click",function(a){window.scrollTo(0,0)})}),this)},d.prototype.refresh=function(a){a=a!==!1;var d=this.element,e=typeof this.template=="object",h=!e&&String(this.template).replace(/{{|}}/g,"")===this.store.key,j=[],k=[],l=this,m=typeof this.callback=="function",n=/{{.*}}/g,o=new RegExp,p=[],q=[],r,s;return this.ready||(this.ready=!0,this.store.parentNode.on("afterDataSet",function(a){if(f(this.store.parentNode,d.id,"afterDataSet","set-"+d.id))return;!this.refreshing&&g.call(this)&&this.refresh()},"set-"+d.id,this)),this.element.fire("beforeDataListRefresh"),this.refreshing=!0,e?r=function(a){var c=b.encode(l.template);return c=c.replace("{{"+l.store.key+"}}",a.key),b.iterate(a.data,function(a,d){o.compile("{{"+d+"}}","g"),c=c.replace(o,b.encode(a).replace(/(^")|("$)/g,""))}),c=b.decode(c.replace(n,l.placeholder)),{li:c}}:r=function(a){var c=String(l.template);return c=c.replace("{{"+l.store.key+"}}",a.key),b.iterate(a.data,function(a,b){o.compile("{{"+b+"}}","g"),c=c.replace(o,a)}),{li:c.replace(n,l.placeholder)}},j=this.order.isEmpty()?this.store.get():this.store.sort(this.order,!1,this.sensitivity),j.each(function(a){l.filter!==null&&l.filter instanceof Object?b.iterate(l.filter,function(b,c){if(p.index(a.key)>-1)return;var d=0,e=new RegExp,f;b=b.explode(),f=b.length;for(d=0;d<f;d++){e.compile(b[d],"i");if(c===l.store.key&&e.test(a.key)||typeof a.data[c]!="undefined"&&e.test(a.data[c])){p.push(a.key),k.push({key:a.key,template:r(a)});return}}}):k.push({key:a.key,template:r(a)})}),this.total=k.length,typeof this.pageIndex=="number"&&typeof this.pageSize=="number"&&(q=i.call(this),k=k.range(q[0],q[1])),a?(d.clear(),k.each(function(a){var b=d.tpl(a.template);b.data("key",a.key),m&&l.callback(b)})):(d.find("> li").addClass("hidden"),k.each(function(a){d.find("> li[data-key='"+a.key+"']").removeClass("hidden")})),c.test(this.pagination)&&typeof this.pageIndex=="number"&&typeof this.pageSize=="number"?this.pages():(b("#"+this.element.id+"-pages-top, #"+this.element.id+"-pages-bottom"),typeof s!="undefined"&&s.destroy()),this.refreshing=!1,this.element.fire("afterDataListRefresh",d),this},d.prototype.sort=function(a,c){if(typeof a!="string")throw Error(b.label.error.invalidArguments);return this.element.fire("beforeDataListSort"),this.order=a,this.sensitivity=c||"ci",this.refresh(),this.element.fire("afterDataListSort"),this},d.prototype.teardown=function(){var a=this.element.id;return this.store.parentNode.un("afterDataDelete","delete-"+a).un("afterDataRetrieve, afterDataSync","refresh-"+a),this};var e=function(c){return b=a[c.aliased],c.module("datalist",d),c.datalist},f=function(a,c,d,e){var f=!1;return typeof b("#"+c)=="undefined"&&(a.un(d,e),f=!0),f},g=function(){return this.store.uri===null||this.store.loaded},h=function(){if(isNaN(this.pageSize))throw Error(b.label.error.invalidArguments);return(this.total/this.pageSize).roundUp()},i=function(){var a=this.pageIndex*this.pageSize-this.pageSize,b=a+this.pageSize-1;return[a,b]};typeof define=="function"?define(["abaaso"],function(a){return e(a)}):abaaso.on("init",function(){e(abaaso)},"abaaso.datalist")})(this);